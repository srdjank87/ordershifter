generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  OWNER
  OPS
  SUPPORT
}

enum MerchantStatus {
  INVITED
  INSTALLED
  ACTIVE
  PAUSED
}

enum OrderState {
  PENDING
  HELD
  READY
  EXPORTED
  ERROR
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  role      Role     @default(OWNER)
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Tenant {
  id              String            @id @default(cuid())
  name            String
  slug            String            @unique
  logoUrl         String?
  settings        TenantSettings?
  users           User[]
  merchants       MerchantAccount[]
  warehouses      Warehouse[]
  routingRules    RoutingRule[] // ✅ ADD THIS
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  orderExceptions OrderException[]
  exportLogs      ExportLog[]
  demoMode        Boolean           @default(false)
}

model TenantSettings {
  id         String   @id @default(cuid())
  tenantId   String   @unique
  tenant     Tenant   @relation(fields: [tenantId], references: [id])

  delayHours              Int     @default(6)
  exportFrequencyMinutes  Int     @default(15)
  timezone                String  @default("America/Toronto")
  exportMode              String  @default("CSV_DOWNLOAD")

  // ✅ add this
  demoMode   Boolean  @default(false)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}


model Warehouse {
  id           String        @id @default(cuid())
  tenantId     String
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  name         String
  code         String
  country      String?
  region       String?
  routingRules RoutingRule[] // ✅ ADD THIS
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@unique([tenantId, code])
}

model MerchantAccount {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  shopDomain String
  status     MerchantStatus @default(INVITED)

  accessToken String? // encrypt later
  scope       String?
  installedAt DateTime?

  orders ShopifyOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orderExceptions OrderException[]
  exportLogs      ExportLog[]

  @@unique([tenantId, shopDomain])
  @@unique([shopDomain])
}

model ShopifyOrder {
  id         String          @id @default(cuid())
  tenantId   String
  merchantId String
  merchant   MerchantAccount @relation(fields: [merchantId], references: [id])

  shopifyOrderId   String
  shopifyName      String?
  createdAtShopify DateTime?
  payload          Json

  state             OrderState @default(PENDING)
  readyAt           DateTime
  routedWarehouseId String?
  exportBatchId     String?

  lastError String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  exceptions OrderException[]
  exportLogs ExportLog[]

  // ✅ add this
  isDemo Boolean @default(false)

  @@unique([merchantId, shopifyOrderId])
  @@index([tenantId, state, readyAt])
}


model RoutingRule {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  priority Int     @default(100)
  enabled  Boolean @default(true)

  // MVP: route by country/region/postalPrefix
  country      String?
  region       String?
  postalPrefix String?

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, enabled, priority])
}

enum ExceptionStatus {
  OPEN
  RESOLVED
}

enum ExportStatus {
  QUEUED
  SENT
  FAILED
}

model OrderException {
  id         String @id @default(cuid())
  tenantId   String
  merchantId String
  orderId    String

  code    String
  message String
  status  ExceptionStatus @default(OPEN)

  createdAt  DateTime  @default(now())
  resolvedAt DateTime?

  tenant   Tenant          @relation(fields: [tenantId], references: [id])
  merchant MerchantAccount @relation(fields: [merchantId], references: [id])
  order    ShopifyOrder    @relation(fields: [orderId], references: [id])

  @@index([tenantId, merchantId, status])
  @@index([orderId])
}

model ExportLog {
  id         String  @id @default(cuid())
  tenantId   String
  merchantId String
  orderId    String?

  status  ExportStatus @default(QUEUED)
  summary String?
  error   String?

  createdAt DateTime @default(now())

  tenant   Tenant          @relation(fields: [tenantId], references: [id])
  merchant MerchantAccount @relation(fields: [merchantId], references: [id])
  order    ShopifyOrder?   @relation(fields: [orderId], references: [id])

  @@index([tenantId, merchantId, createdAt])
}
