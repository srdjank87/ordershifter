// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========= Enums =========

enum UserRole {
  SUPERADMIN
  THREE_PL_ADMIN
  MERCHANT_ADMIN
  SUPPORT
}

enum MerchantStatus {
  PENDING
  ACTIVE
  SUSPENDED
  DISCONNECTED
}

enum OrderSource {
  SHOPIFY
  CSV
  MANUAL
  OTHER
}

enum OrderStatus {
  PENDING_IMPORT
  IMPORTED
  READY_TO_EXPORT
  EXPORTING
  EXPORTED
  FAILED
  CANCELLED
}

enum JobType {
  IMPORT_ORDERS
  EXPORT_FULFILLMENTS
  SYNC_PRODUCTS
  GENERIC
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  RETRYING
  CANCELLED
}

enum WebhookDirection {
  INBOUND
  OUTBOUND
}

// ========= Core org models =========

model ThreePL {
  id          String             @id @default(cuid())
  name        String
  slug        String             @unique
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  users       User[]
  merchants   MerchantAccount[]
  warehouses  Warehouse[]
  orders      Order[]
}

model User {
  id          String        @id @default(cuid())
  email       String        @unique
  name        String?
  role        UserRole
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  threePlId   String?
  threePl     ThreePL?      @relation(fields: [threePlId], references: [id])

  merchantId  String?
  merchant    MerchantAccount? @relation(fields: [merchantId], references: [id])

  @@index([threePlId])
  @@index([merchantId])
}

model MerchantAccount {
  id            String          @id @default(cuid())
  threePlId     String
  threePl       ThreePL         @relation(fields: [threePlId], references: [id])

  name          String
  shopDomain    String          // e.g. my-store.myshopify.com
  shopifyShopId String?
  status        MerchantStatus  @default(ACTIVE)

  accessToken   String?

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  orders        Order[]
  users         User[]

  @@index([threePlId])
  @@unique([threePlId, shopDomain])
}

model Warehouse {
  id        String    @id @default(cuid())
  threePlId String
  threePl   ThreePL   @relation(fields: [threePlId], references: [id])

  name      String
  code      String
  city      String?
  region    String?
  country   String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  orders    Order[]

  @@index([threePlId])
  @@unique([threePlId, code])
}

// ========= Orders =========

model Order {
  id              String         @id @default(cuid())
  threePlId       String
  threePl         ThreePL        @relation(fields: [threePlId], references: [id])

  merchantId      String
  merchant        MerchantAccount @relation(fields: [merchantId], references: [id])

  warehouseId     String?
  warehouse       Warehouse?     @relation(fields: [warehouseId], references: [id])

  source          OrderSource
  status          OrderStatus    @default(PENDING_IMPORT)

  externalOrderId String
  orderNumber     String?
  currency        String?
  totalCents      Int?

  rawPayload      Json?

  syncedAt        DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  items           OrderItem[]
  jobs            IntegrationJob[]
  webhookLogs     WebhookLog[]

  @@index([threePlId, status])
  @@index([merchantId])
  @@index([externalOrderId])
}

model OrderItem {
  id             String   @id @default(cuid())
  orderId        String
  order          Order    @relation(fields: [orderId], references: [id])

  sku            String
  name           String
  quantity       Int
  unitPriceCents Int?
  currency       String?

  createdAt      DateTime @default(now())

  @@index([orderId])
}

// ========= Background jobs & logs =========

model IntegrationJob {
  id           String     @id @default(cuid())
  type         JobType
  status       JobStatus  @default(PENDING)
  queueName    String

  orderId      String?
  order        Order?     @relation(fields: [orderId], references: [id])

  attempts     Int        @default(0)
  maxAttempts  Int        @default(5)

  payload      Json?
  lastError    String?

  scheduledAt  DateTime?
  startedAt    DateTime?
  finishedAt   DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([queueName, status])
  @@index([orderId])
}

model WebhookLog {
  id           String            @id @default(cuid())
  direction    WebhookDirection
  url          String
  statusCode   Int?

  orderId      String?
  order        Order?            @relation(fields: [orderId], references: [id])

  payload      Json?
  responseBody String?
  error        String?

  createdAt    DateTime          @default(now())

  @@index([orderId])
}
